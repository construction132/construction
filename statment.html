<html>

<head>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="styles/statment.css">
</head>

<body>
    <section> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span>
        <div class="header">
            <a href="New.html" class="btn">project</a>
            <a href="action.html" class="btn">Cash in /Cash out</a>
            <a href="statment.html" class="btn">Statment</a>
            <a href="loan.html" class="btn">Loans</a>
            <a href="index.html" class="btn">Logout</a>
        </div>

        <div class="signin">
            <h1>select a project</h1>
            <div id="choice"></div>
            <br>
            <button id="Submit">Submit</button>
            <div id="statment">

            </div>
            <div id="statment2">

            </div>
            <button id="delete" style="display: none;">Delete Last Action</button>
        </div>

    </section>
    <script>
        const socket = io()
        let username = "";
        const storedUsername = localStorage.getItem("username");
        if (storedUsername !== null) {
            username = storedUsername;
            if (localStorage.getItem("username") == "admin")
                document.getElementById("statment2").style.display = "none"
            else if (localStorage.getItem("username") == "user")
                document.getElementById("statment").style.display = "none"
        }
        socket.emit("checkuser", username)

        socket.on("goLogin", (path) => {
            //locate the user to the path
            window.location = `./${path}`;
        })

        let project = null
        socket.emit("getProjects")
        socket.on("sendProjects", (projects) => {

            project = projects;
            console.log('sending projects');
            let selectElement = document.createElement("select");
            selectElement.setAttribute("id", "projectSelect");

            for (let i = 0; i < projects.length; i++) {
                let optionElement = document.createElement("option");
                optionElement.textContent = projects[i].project;
                selectElement.appendChild(optionElement);
            }

            let choiceDiv = document.getElementById("choice");
            choiceDiv.innerHTML = "";
            choiceDiv.appendChild(selectElement);
        });

        document.getElementById("Submit").addEventListener("click", () => {
            let selectElement = document.getElementById("projectSelect");
            let selectedProject = selectElement.value;
            socket.emit("getspecificProject", selectedProject);
        });

        socket.on("sendActions", (actions) => {
            console.log("in send actions")
            project = actions;

            let statementDiv = document.getElementById("statment");
            statementDiv.innerHTML = ""; // clear the contents of the statement div

            // create a table element
            let tableElement = document.createElement("table");
            tableElement.id = "detailTable"
            // create a table row for the table header
            let headerRow = document.createElement("tr");

            let keysToInclude2 = ["N", "action type", "value", "source", "taker", "purpose", "remaining Total", "total Paid", "date"];
            //adding the loans dynamiclly
            let remainingKeys = Object.keys(project[project.length - 1].remainingLoans).map(key => "remaining " + key);
            let allKeysToInclude = [...keysToInclude2.slice(0, 6), ...remainingKeys, ...keysToInclude2.slice(6)];
            for (let i = 0; i < allKeysToInclude.length; i++) {
                let headerCell = document.createElement("th");
                headerCell.textContent = allKeysToInclude[i];
                headerRow.appendChild(headerCell);
            }
            tableElement.appendChild(headerRow);
            //specify the nassasry colomns
            let keysToInclude = ["actionNumber", "actionType", "value", "source", "taker", "purpose", "totalRemaining", "totalPaid", "date"];
            //adding the loans dynamiclly
            let loanKeys = Object.keys(project[project.length - 1].remainingLoans);
            allKeysToInclude = [...keysToInclude.slice(0, 6), ...loanKeys, ...keysToInclude.slice(6)];
            // create a table row for each object in the project list
            console.log("actions are " + project[0])

            for (let i = 0; i < project.length; i++) {
                let dataRow = document.createElement("tr");
                for (let j = 0; j < allKeysToInclude.length; j++) {
                    let dataCell = document.createElement("td");

                    // If the current key is a loan key, get the loan value from the loans object
                    if (loanKeys.includes(allKeysToInclude[j])) {
                        let loanValue = project[i].remainingLoans[allKeysToInclude[j]];
                        dataCell.textContent = loanValue !== undefined ? loanValue : "";
                    }
                    // Otherwise, get the value from the current object
                    else {
                        dataCell.textContent = project[i][allKeysToInclude[j]];
                    }

                    dataRow.appendChild(dataCell);
                }
                tableElement.appendChild(dataRow);
                tableElement.style.display = "none"
                //redefine the loan for the row if it is not the last row
                // if (i + 1 !== project.length) {
                //     loanKeys = Object.keys(project[i + 1].loans);;
                //     allKeysToInclude = [...keysToInclude.slice(0, 6), ...loanKeys, ...keysToInclude.slice(6)];
                // }

            }

            statementDiv.appendChild(tableElement);
            makeColapsTable(project)



            let space = document.createElement("br")
            statementDiv.appendChild(space)
            const btn3 = document.createElement("button")
            btn3.appendChild(space)
            btn3.id = "colapsbtn"
            btn3.innerHTML = "Show Detail";
            statementDiv.appendChild(btn3);

            let check2 = false
            btn3.addEventListener("click", () => {
                if (!check2) {
                    document.getElementById("collapsedDetailTable").style.display = "none"
                    document.getElementById("detailTable").style.display = "block"
                    btn3.innerHTML = "Show Colapse"
                    check2 = true

                } else {
                    console.log("in else")
                    document.getElementById("collapsedDetailTable").style.display = "block"
                    document.getElementById("detailTable").style.display = "none"
                    btn3.innerHTML = "Show Detail"
                    check2 = false
                }
            })



            const btn = document.createElement("button")
            btn.id = "summaryBtn"
            btn.innerHTML = "Show Summary";
            statementDiv.appendChild(btn);
            if (localStorage.getItem("username") === "admin") {
                statementDiv.style.display = "flex"
                statementDiv.style.flexDirection = "column"
                statementDiv.style.justifyContent = "center"
                statementDiv.style.alignItems = "center"
                editabletable()
            }
            else {
                statementDiv.style.display = "none"
            }


            // create a table element
            tableElement = document.createElement("table");
            tableElement.id = "summaryTable"
            statementDiv = document.getElementById("statment2");
            statementDiv.innerHTML = ""; // clear the contents of the statement div
            // create a table row for the table header
            headerRow = document.createElement("tr");
            objectKeys = Object.keys(project[0]); // get the keys of the first object in the project list
            objectKeys = objectKeys.slice(1, -1);
            console.log(objectKeys)
            keysToInclude2 = ["N", "total", "remaining Total", "total Paid", "date"];
            remainingKeys = Object.keys(project[project.length - 1].remainingLoans).map(key => "remaining " + key);
            allKeysToInclude = [...keysToInclude2.slice(0, 2), ...remainingKeys, ...keysToInclude2.slice(2)];
            for (let i = 0; i < allKeysToInclude.length; i++) {
                let headerCell = document.createElement("th");
                headerCell.textContent = allKeysToInclude[i];
                headerRow.appendChild(headerCell);
            }
            tableElement.appendChild(headerRow);
            //specify the nassasry colomns
            keysToInclude = ["actionNumber", "value", "totalRemaining", "totalPaid", "date"];
            loanKeys = Object.keys(project[project.length - 1].remainingLoans);
            allKeysToInclude = [...keysToInclude.slice(0, 2), ...loanKeys, ...keysToInclude.slice(2)];
            // create a table row for each object in the project list
            for (let i = 0; i < project.length; i++) {
                let dataRow = document.createElement("tr");
                for (let j = 0; j < allKeysToInclude.length; j++) {
                    let dataCell = document.createElement("td");

                    if (allKeysToInclude[j] === "total") {
                        dataCell.textContent = project[i]["value"]
                    }
                    if (loanKeys.includes(allKeysToInclude[j])) {
                        let loanValue = project[i]["remainingLoans"][allKeysToInclude[j]];
                        dataCell.textContent = loanValue !== undefined ? loanValue : "";
                    }
                    // Otherwise, get the value from the current object
                    else {
                        dataCell.textContent = project[i][allKeysToInclude[j]];
                    }
                    dataRow.appendChild(dataCell);
                }
                tableElement.appendChild(dataRow);
            }
            statementDiv.appendChild(tableElement);




            const btn2 = document.createElement("button")
            statementDiv.appendChild(space)
            btn2.id = "detailsBtn"
            btn2.innerHTML = "Show Details";
            statementDiv.appendChild(btn2);
            if (localStorage.getItem("username") === "user") {
                statementDiv.style.display = "flex"
                statementDiv.style.flexDirection = "column"
                statementDiv.style.justifyContent = "center"
                statementDiv.style.alignItems = "center"
            }
            else {
                console.log("in else")
                statementDiv.style.display = "none"
            }
            document.getElementById("delete").style.display = "block"



            let check = false
            document.getElementById("detailsBtn").addEventListener("click", () => {
                if (!check) {
                    console.log("in if")
                    document.getElementById("statment").style.display = "flex"
                    document.getElementById("statment").style.flexDirection = "column"
                    document.getElementById("statment").style.justifyContent = "center"
                    document.getElementById("statment").style.alignItems = "center"
                    document.getElementById("summaryBtn").style.display = "none"
                    document.getElementById("detailsBtn").innerHTML = "Hide Details"
                    check = true
                    editabletable()



                } else {
                    console.log("in else")
                    document.getElementById("statment").style.display = "none"
                    document.getElementById("detailsBtn").innerHTML = "Show Details"
                    check = false
                }
            })
            document.getElementById("summaryBtn").addEventListener("click", () => {
                if (!check) {
                    console.log("in if")
                    document.getElementById("statment2").style.display = "flex"
                    document.getElementById("statment2").style.flexDirection = "column"
                    document.getElementById("statment2").style.justifyContent = "center"
                    document.getElementById("statment2").style.alignItems = "center"
                    document.getElementById("detailsBtn").style.display = "none"
                    document.getElementById("summaryBtn").innerHTML = "Hide Summury"
                    check = true
                } else {
                    console.log("in else")
                    document.getElementById("statment2").style.display = "none"
                    document.getElementById("summaryBtn").innerHTML = "Show Summury"
                    check = false
                }
            })
        })

        document.getElementById("delete").addEventListener("click", () => {

            let selectElement = document.getElementById("projectSelect");
            let selectedProject = selectElement.value;

            if (confirm("Are you sure you want to delete the last action?")) {
                socket.emit("deleteLastAction", selectedProject);
            }
        });
        let check2 = false
        function editabletable() {
            console.log("in function")
            let detailTable = document.getElementById("detailTable");
            let cells = detailTable.getElementsByTagName("td");
            let rows = [];
            for (let i = 0; i < cells.length; i++) {
                let cell = cells[i];
                let content = cell.textContent.trim();

                // Skip cells that shouldn't be editable
                if (cell.querySelector("input, button") || content === "") {

                    continue;
                }

                cell.addEventListener("dblclick", function () {

                    let input = document.createElement("input");
                    input.type = "text";
                    input.value = content;
                    input.className = "editable-cell";

                    // Set the appropriate size and style for the input element
                    input.style.width = cell.offsetWidth + "px";
                    input.style.height = cell.offsetHeight + "px";
                    input.style.fontSize = window.getComputedStyle(cell).getPropertyValue("font-size");

                    // Replace the contents of the cell with the input element
                    cell.innerHTML = "";
                    cell.appendChild(input);

                    // Select the contents of the input element
                    input.select();

                    // Add an event listener to the input element to listen for the blur event
                    input.addEventListener("blur", () => {
                        let newValue = input.value.trim();

                        // If the new value is different from the old value, update the cell
                        if (newValue !== content) {
                            cell.textContent = newValue;

                            // Update the corresponding row object
                            let rowIndex = cell.parentNode.rowIndex - 1;
                            let header = detailTable.getElementsByTagName("th");
                            let row = {};

                            for (let j = 0; j < header.length; j++) {
                                let key = header[j].textContent.trim();
                                let value = detailTable.rows[rowIndex + 1].cells[j].textContent.trim();
                                row[key] = value;
                            }

                            rows[rowIndex] = row;

                            // Print the row object to the console for debugging purposes
                            console.log(row["abaa Out"]);
                            row.projectOwner = document.getElementById("projectSelect").value
                            socket.emit("editAction", row)
                        } else {
                            // If the new value is the same as the old value, restore the original content
                            cell.textContent = content;
                        }
                    });
                });
            }
        }




        socket.on("sendUpdatedActions", (actions) => {
            console.log("in update actions")
            project = actions;
            let statementDiv = document.getElementById("statment");
            statementDiv.innerHTML = ""; // clear the contents of the statement div

            // create a table element
            let tableElement = document.createElement("table");
            tableElement.id = "detailTable"
            // create a table row for the table header
            let headerRow = document.createElement("tr");
            let keysToInclude2 = ["N", "action type", "value", "source", "taker", "purpose", "remaining Total", "total Paid", "date"];
            //adding the loans dynamiclly
            let remainingKeys = Object.keys(project[project.length - 1].remainingLoans).map(key => "remaining " + key);
            let allKeysToInclude = [...keysToInclude2.slice(0, 6), ...remainingKeys, ...keysToInclude2.slice(6)];
            for (let i = 0; i < allKeysToInclude.length; i++) {
                let headerCell = document.createElement("th");
                headerCell.textContent = allKeysToInclude[i];
                headerRow.appendChild(headerCell);
            }
            tableElement.appendChild(headerRow);
            //specify the nassasry colomns
            let keysToInclude = ["actionNumber", "actionType", "value", "source", "taker", "purpose", "totalRemaining", "totalPaid", "date"];
            //adding the loans dynamiclly
            let loanKeys = Object.keys(project[project.length - 1].remainingLoans);
            allKeysToInclude = [...keysToInclude.slice(0, 6), ...loanKeys, ...keysToInclude.slice(6)];
            // create a table row for each object in the project list
            console.log("actions are " + allKeysToInclude)

            for (let i = 0; i < project.length; i++) {
                let dataRow = document.createElement("tr");
                for (let j = 0; j < allKeysToInclude.length; j++) {
                    let dataCell = document.createElement("td");

                    // If the current key is a loan key, get the loan value from the loans object
                    if (loanKeys.includes(allKeysToInclude[j])) {
                        let loanValue = project[i].remainingLoans[allKeysToInclude[j]];
                        dataCell.textContent = loanValue !== undefined ? loanValue : "";
                    }
                    // Otherwise, get the value from the current object
                    else {
                        dataCell.textContent = project[i][allKeysToInclude[j]];
                    }

                    dataRow.appendChild(dataCell);
                }
                tableElement.appendChild(dataRow);
                //redefine the loan for the row if it is not the last row
                // if (i + 1 !== project.length) {
                //     loanKeys = Object.keys(project[i + 1].loans);;
                //     allKeysToInclude = [...keysToInclude.slice(0, 6), ...loanKeys, ...keysToInclude.slice(6)];
                // }

            }
            statementDiv.appendChild(tableElement);
            let space = document.createElement("br")
            statementDiv.appendChild(space)
            const btn = document.createElement("button")
            btn.id = "summaryBtn"
            btn.innerHTML = "Show Summary";
            if (localStorage.getItem("username") == "admin")
                statementDiv.appendChild(btn);
            editabletable()


            // create a table element
            tableElement = document.createElement("table");
            tableElement.id = "summaryTable"
            statementDiv = document.getElementById("statment2");
            statementDiv.innerHTML = ""; // clear the contents of the statement div
            // create a table row for the table header
            headerRow = document.createElement("tr");
            objectKeys = Object.keys(project[0]); // get the keys of the first object in the project list
            objectKeys = objectKeys.slice(1, -1);
            console.log(objectKeys)
            keysToInclude2 = ["N", "totsal", "remaining Abaa", "remaining Umi", "remaining Total", "total Paid", "date"];
            for (let i = 0; i < keysToInclude2.length; i++) {
                let headerCell = document.createElement("th");
                headerCell.textContent = keysToInclude2[i];
                headerRow.appendChild(headerCell);
            }
            tableElement.appendChild(headerRow);
            //specify the nassasry colomns
            keysToInclude = ["actionNumber", "total", "abaa", "umi", "totalRemaining", "totalTotal", "date"];
            // create a table row for each object in the project list
            for (let i = 0; i < project.length; i++) {
                let dataRow = document.createElement("tr");
                for (let j = 0; j < keysToInclude.length; j++) {
                    let dataCell = document.createElement("td");

                    // If the current key is a loans key, get the loan value from the loans object
                    if (keysToInclude[j] === "abaa" || keysToInclude[j] === "umi") {
                        let loanValue = project[i]["remainingLoans"][keysToInclude[j]];
                        dataCell.textContent = loanValue !== undefined ? loanValue : "";
                    }
                    // Otherwise, get the value from the current object
                    else {
                        dataCell.textContent = project[i][keysToInclude[j]];
                    }
                    dataRow.appendChild(dataCell);
                }
                tableElement.appendChild(dataRow);
            }
            statementDiv.appendChild(tableElement);
            const btn2 = document.createElement("button")
            statementDiv.appendChild(space)
            btn2.id = "detailsBtn"
            btn2.innerHTML = "Hide Details";
            statementDiv.appendChild(btn2);
            document.getElementById("delete").style.display = "block"


            let check2 = true
            document.getElementById("detailsBtn").addEventListener("click", () => {

                console.log("button has been clicked")
                if (!check2) {
                    console.log("in if")
                    document.getElementById("statment").style.display = "flex"
                    document.getElementById("statment").style.flexDirection = "column"
                    document.getElementById("statment").style.justifyContent = "center"
                    document.getElementById("statment").style.alignItems = "center"

                    document.getElementById("detailsBtn").innerHTML = "Hide Details"
                    check2 = true
                    editabletable()



                } else {
                    console.log("in else")
                    document.getElementById("statment").style.display = "none"
                    document.getElementById("detailsBtn").innerHTML = "Show Details"
                    check2 = false
                }
            })
            document.getElementById("summaryBtn").addEventListener("click", () => {
                if (!check2) {
                    console.log("in if")
                    document.getElementById("statment2").style.display = "flex"
                    document.getElementById("statment2").style.flexDirection = "column"
                    document.getElementById("statment2").style.justifyContent = "center"
                    document.getElementById("statment2").style.alignItems = "center"

                    document.getElementById("summaryBtn").innerHTML = "Hide Summuary"
                    check2 = true
                } else {
                    console.log("in else")
                    document.getElementById("statment2").style.display = "none"
                    document.getElementById("summaryBtn").innerHTML = "Show Summuary"
                    check2 = false
                }
            })



            function editabletable() {
                console.log("in function")
                let detailTable = document.getElementById("detailTable");
                let cells = detailTable.getElementsByTagName("td");
                let rows = [];
                for (let i = 0; i < cells.length; i++) {
                    let cell = cells[i];
                    let content = cell.textContent.trim();

                    // Skip cells that shouldn't be editable
                    if (cell.querySelector("input, button") || content === "") {

                        continue;
                    }

                    cell.addEventListener("dblclick", function () {

                        let input = document.createElement("input");
                        input.type = "text";
                        input.value = content;
                        input.className = "editable-cell";

                        // Set the appropriate size and style for the input element
                        input.style.width = cell.offsetWidth + "px";
                        input.style.height = cell.offsetHeight + "px";
                        input.style.fontSize = window.getComputedStyle(cell).getPropertyValue("font-size");

                        // Replace the contents of the cell with the input element
                        cell.innerHTML = "";
                        cell.appendChild(input);

                        // Select the contents of the input element
                        input.select();

                        // Add an event listener to the input element to listen for the blur event
                        input.addEventListener("blur", () => {
                            let newValue = input.value.trim();

                            // If the new value is different from the old value, update the cell
                            if (newValue !== content) {
                                cell.textContent = newValue;

                                // Update the corresponding row object
                                let rowIndex = cell.parentNode.rowIndex - 1;
                                let header = detailTable.getElementsByTagName("th");
                                let row = {};

                                for (let j = 0; j < header.length; j++) {
                                    let key = header[j].textContent.trim();
                                    let value = detailTable.rows[rowIndex + 1].cells[j].textContent.trim();
                                    row[key] = value;
                                }

                                rows[rowIndex] = row;

                                // Print the row object to the console for debugging purposes
                                console.log(row["abaa Out"]);
                                row.projectOwner = document.getElementById("projectSelect").value
                                socket.emit("editAction", row)
                            } else {
                                // If the new value is the same as the old value, restore the original content
                                cell.textContent = content;
                            }
                        });
                    });
                }
            }


        })
        function makeColapsTable(project) {
            localStorage.removeItem('value')
            localStorage.removeItem("value2")
            // Find the table element
            let tableElement = document.getElementById("detailTable");

            // Create a new table element for the collapsed rows
            let collapsedTableElement = document.createElement("table");
            collapsedTableElement.id = "collapsedDetailTable";

            // Create a table row for the table header
            let headerRow = document.createElement("tr");

            // Define the keys that will be included in the collapsed rows
            let keysToInclude2 = ["N", "action type", "value", "source", "taker", "purpose", "date"];
            // adding the loans dynamically
            let remainingKeys = "";
            let allKeysToInclude = [...keysToInclude2.slice(0, 6), ...remainingKeys, ...keysToInclude2.slice(6)];

            // Create table header cells for the keys to include
            for (let i = 0; i < allKeysToInclude.length; i++) {
                let headerCell = document.createElement("th");
                headerCell.textContent = allKeysToInclude[i];
                headerRow.appendChild(headerCell);
            }
            collapsedTableElement.appendChild(headerRow);

            // Create a mapping of date-taker pairs to their corresponding rows
            let dateTakerToRowsMap = {};

            // Iterate over each row in the table (skip the first row, which contains the headers)
            for (let i = 1; i < tableElement.rows.length; i++) {
                let row = tableElement.rows[i];

                // Get the cells in the row
                let cells = row.getElementsByTagName("td");

                // Get the date and taker values from the current row
                let currentDate = cells[cells.length - 1].textContent;
                let currentTaker = cells[4].textContent;
                let dateTakerKey = currentDate + "_" + currentTaker;

                // If the date-taker key exists in the map, update the row reference to the current row
                if (dateTakerToRowsMap[dateTakerKey]) {


                    console.log(" the key exist and it is  " + dateTakerKey)
                    // Concatenate the values of cells 0, 1, 3, and 5
                    dateTakerToRowsMap[dateTakerKey].cells[0].textContent += ", " + cells[0].textContent;
                    dateTakerToRowsMap[dateTakerKey].cells[1].textContent += ", " + cells[1].textContent;
                    dateTakerToRowsMap[dateTakerKey].cells[3].textContent += ", " + cells[3].textContent;
                    dateTakerToRowsMap[dateTakerKey].cells[5].textContent += ", " + cells[5].textContent;
                    
                    localStorage.setItem("value",localStorage.getItem("value")+","+cells[3].textContent+cells[2].textContent)
                    // Update the value for cell 2 (parse the content as an integer and then add)
                    let currentValue = parseInt(dateTakerToRowsMap[dateTakerKey].cells[2].textContent);
                    let additionalValue = parseInt(cells[2].textContent);
                    dateTakerToRowsMap[dateTakerKey].cells[2].textContent = (currentValue + additionalValue).toString();

                } else {
                    // If the date-taker key doesn't exist, create a new row and add it to the map
                    let newRow = collapsedTableElement.insertRow();
                    for (let j = 0; j < 6; j++) {
                        let newCell = newRow.insertCell();
                        if (j != 2)
                            newCell.textContent = cells[j].textContent;
                        else {
                            let check=false
                            newCell.addEventListener("click", () => {
                                console.log("click");

                                if(!check){
                                    localStorage.setItem("value2",`${newCell.textContent}`)
                                    newCell.textContent=localStorage.getItem("value")
                                    check=true
                                }else{
                                    newCell.textContent=localStorage.getItem("value2")
                                    check=false
                                }
                            });
                            newCell.textContent = cells[j].textContent;
                        }


                    }
                    
                    let newCell = newRow.insertCell();
                    newCell.textContent = cells[cells.length - 1].textContent;
                  
                    // Add the new row to the map with the current date-taker key
                    dateTakerToRowsMap[dateTakerKey] = newRow;
                }
                // Insert the collapsed table after the original table
                tableElement.parentNode.insertBefore(collapsedTableElement, tableElement.nextSibling);
            }



        }

    </script>
</body>

</html>