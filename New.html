<html>

<head>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="styles/statment.css">
</head>

<body>
    <section> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span>

        <div class="header">
            <a href="New.html" class="btn">project</a>
            <a href="action.html" class="btn">Cash in /Cash out</a>
            <a href="statment.html" class="btn">Statment</a>
            <a href="loan.html" class="btn">Loans</a>
            <a href="index.html" class="btn">Logout</a>
        </div>

        <div class="signin">
            <h1 style="color: rgb(0, 248, 0) ;">select an option</h1>
            <div class="inputbtn">
                <button id="create">create project</button>
                <button id="delete">delete project</button>
            </div>

            <br><br>

            <form action="" id="form" style="display: none;">
                <div class="inputBox">

                    <input type="date" id="date" value="" required> <i>Date</i>

                </div>
                <div class="inputBox">

                    <input type="text" id="projectName" required> <i>Project name</i>

                </div>
                <div class="inputBox">

                    <input type="number" id="aishaLoan" required> <i>Umi starting loan</i>

                </div>
                <div class="inputBox">

                    <input type="number" id="abaaLoan" required> <i>Abaa starting loan</i>

                </div>

                <div class="inputBox">
                    <input type="number" id="rageebLoan" required> <i>Rageeb starting loan</i>
                </div>

                <div class="inputBox">

                    <input type="number" id="omarLoan" required> <i>khal omar starting loan</i>

                </div>



            </form>
            <button id="add" style="display: none;">Add new loaner</button>
            <button id="Submit" style="display: none;">Submit</button>
            <form action="" id="form2" style="display: none;">


                <div id="choice"></div>

                <button id="Submit2">Submit</button>

            </form>

        </div>

    </section>

    <script>
        const socket = io()
        let username = "";
        const storedUsername = localStorage.getItem("username");
        if (storedUsername !== null) {
            username = storedUsername;
        }
        socket.emit("checkuser", username)

        socket.on("goLogin", (path) => {
            //locate the user to the path
            window.location = `./${path}`;
        })


        //display forms
        document.getElementById("create").addEventListener("click", () => {
            document.getElementById("form").style.display = "flex";
            document.getElementById("Submit").style.display = "block";
            document.getElementById("add").style.display = "block";
            document.getElementById("form2").style.display = "none";
            console.log("hi")
        })
        document.getElementById("delete").addEventListener("click", () => {
            document.getElementById("form2").style.display = "flex";
            document.getElementById("Submit").style.display = "none";
            document.getElementById("add").style.display = "none";
            document.getElementById("form").style.display = "none";

            console.log("hi")
        })

        socket.emit("getProjects")
        socket.on("sendProjects", (projects) => {

            project = projects;
            console.log('sending projects');
            let selectElement = document.createElement("select");
            selectElement.setAttribute("id", "projectSelect");

            for (let i = 0; i < projects.length; i++) {
                let optionElement = document.createElement("option");
                optionElement.textContent = projects[i].project;
                selectElement.appendChild(optionElement);
            }

            let choiceDiv = document.getElementById("choice");
            choiceDiv.innerHTML = "";
            choiceDiv.appendChild(selectElement);
        });

        let check=true
        //getting the values
        document.getElementById("Submit").addEventListener("click", () => {
            event.preventDefault();

            // Get the values of the static input fields
            const loans = {
                abaa: parseInt(document.getElementById("abaaLoan").value) || 0,
                umi: parseInt(document.getElementById("aishaLoan").value) || 0,
                rageeb: parseInt(document.getElementById("rageebLoan").value) || 0,
                omar: parseInt(document.getElementById("omarLoan").value) || 0,
            };
            let projectname = document.getElementById("projectName").value || "";
            let date = document.getElementById("date").value || "";

            // Loop through all the dynamically added input elements
            const dynamicLoaners = [];
           
            const dynamicInputElements = document.querySelectorAll('input:not([type="submit"]):not([type="text"]):not([id^="aisha"]):not([id^="abaa"]):not([id^="rageeb"]):not([id^="omar"]):not([type="date"])');
            dynamicInputElements.forEach((inputElement) => {
                const parentElement = inputElement.parentElement;
                const loanerName = parentElement.previousElementSibling.querySelector('input[type="text"]');
                let words = loanerName.value.split(" "); // Split the string by spaces to get 
                if(words.length>1){
                    check=false
                    console.log("loaner connot have space")
                    alert("loaner name connot have space")
                    return
                }
                const loanAmount = parseInt(inputElement.value.trim()) || 0;
                if (loanerName) {
                    dynamicLoaners.push({
                        name: loanerName.value.trim().toLowerCase(),
                        loan: loanAmount,
                    });
                    if (loans[loanerName.value.trim().toLowerCase()]) {
                        loans[loanerName.value.trim().toLowerCase()] += loanAmount;
                    } else {
                        loans[loanerName.value.trim().toLowerCase()] = loanAmount;
                    }
                }
            });

            // Print the collected data in the console
            console.log({
                loans,
                projectname,
                date,
                dynamicLoaners,
            });

            if(check)
            socket.emit("storeProject", { loans,projectname, date  })
            socket.once("projectRespones", (message) => {

                alert(message)
                return
            })

        })

        document.getElementById("Submit2").addEventListener("click", () => {
            event.preventDefault();

            let project = "";
            if (document.getElementById("projectSelect").value == null) {
                alert("project name cannot be empty");
                return;
            } else {
                project = document.getElementById("projectSelect").value;
            }

            // Show a confirmation dialog
            let confirmed = confirm(`Are you sure you want to remove the project "${project}"?`);

            if (confirmed) {
                socket.emit("removeProject", project);
                socket.once("projectRespones", (message) => {
                    alert(message);
                    return;
                });
            } else {
                console.log("User cancelled project removal");
            }
        });


    </script>

    <script>



        document.getElementById("add").addEventListener("click", () => {
            event.preventDefault();

            // Get a reference to the parent element
            const parentElement = document.getElementById("form");

            // Create a new div element
            const newDiv = document.createElement("div");

            // Set the class attribute of the new div
            newDiv.setAttribute("class", "inputBox");


            // Set the inner HTML of the name div
            newDiv.innerHTML = `<input type="text" id="name" required> <i>the name of the loaner</i>`;

            // Create a new div element
            const newDiv2 = document.createElement("div");

            // Set the class attribute of the new div
            newDiv2.setAttribute("class", "inputBox");


            // Set the inner HTML of the name div
            newDiv2.innerHTML = `<input type="number" id="amount" required> <i>Loan amount</i>`;

            // Append the new div as a child of the parent element
            parentElement.appendChild(newDiv);


            // Append the new div as a child of the parent element
            parentElement.appendChild(newDiv2);
        });
    </script>
</body>

</html>