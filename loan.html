<html>

<head>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="styles/statment.css">
</head>

<body>

    <section> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span>

        <div class="header">
            <a href="New.html" class="btn">project</a>
            <a href="action.html" class="btn">Cash in /Cash out</a>
            <a href="statment.html" class="btn">Statment</a>
            <a href="loan.html" class="btn">Loans</a>
            <a href="index.html" class="btn">Logout</a>
        </div>

        <div class="signin" style="width: auto;">
            <div style="display: flex; flex-direction: column;align-items: center;" style="width: auto;">
                <h1 style="color: rgb(0, 248, 0) ;">select a loan</h1>
                <br><br>
                <div id="choice">

                </div>
                <br><br>
                <button id="project">submit</button>
                <br><br>
                <h3 id="loanname" style="color: rgb(0, 248, 0) ;"></h3>
                <div  id="btns" style="display: none;" >
                    <button id="show">show loans</button>
                    <button id="add">add loan</button>
                </div>
                <br>
                <div class="inputbtn" style="display: none;" id="buttons" >
        
                </div>
        
                <br><br>

                <form action="" id="form" style="display: none;">
                    <h3 id="loaner3" style="color: rgb(0, 248, 0) ;"></h3>
                    <div id="statment">

                    </div>
                    <button id="resources">Show Resources</button>
                    <div id="resourceschedual" style="display: none;">

                    </div>
                </form>
                <form action="" id="form2" style="display: none;">
                    <h3 id="loaner" style="color: rgb(0, 248, 0) ;"></h3>
                    <div class="inputBox">

                        <input type="date" id="date"> <i>Date</i>

                    </div>
                    <div class="inputBox">

                        <input type="number" name="" id="loan"> <i>value</i>

                    </div>
                    <br><br>
                    <button id="existedLoan">Submit</button>
                </form>
                <form action="" id="form3" style="display: none;">
                    <h3 id="loaner2" style="color: rgb(0, 248, 0) ;"></h3>
                    <div class="inputBox">

                        <input type="date" id="date2"> <i>Date</i>

                    </div>
                    <div class="inputBox">

                        <input type="text" name="" id="loanerName"> <i>name</i>

                    </div>
                    <div class="inputBox">

                        <input type="number" name="" id="loan2"> <i>value</i>

                    </div>
                    <br><br>
                    <button id="newLoan">Submit</button>
                </form>

                
            </div>

        </div>

    </section>

    <script>
        const socket = io()
        let username = "";
        const storedUsername = localStorage.getItem("username");
        if (storedUsername !== null) {
            username = storedUsername;
        }
        socket.emit("checkuser", username)

        socket.on("goLogin", (path) => {
            //locate the user to the path
            window.location = `./${path}`;
        })

        socket.emit("getProjects")
        socket.on("sendProjects", (projects) => {
            project = projects;
            console.log('sending projects');
            let selectElement = document.createElement("select");
            selectElement.setAttribute("id", "projectSelect");

            for (let i = 0; i < projects.length; i++) {
                let optionElement = document.createElement("option");
                optionElement.textContent = projects[i].project;
                selectElement.appendChild(optionElement);
            }

            let choiceDiv = document.getElementById("choice");
            choiceDiv.innerHTML = "";
            choiceDiv.appendChild(selectElement);
        });

        let loaner=""

        let loanOwner=""
        let projectOwner=""
        //display forms
        document.getElementById("project").addEventListener("click", () => {
            document.getElementById("btns").style.display = "flex";
            
            let project = document.getElementById("projectSelect").value
            projectOwner=project
            document.getElementById("loanname").innerHTML = project + " project"

        })

        document.getElementById("show").addEventListener("click", () => {
            document.getElementById("buttons").style.display = "flex";
            document.getElementById("form").style.display = "none";
            document.getElementById("form2").style.display = "none";
            document.getElementById("form3").style.display = "none";
            let project = document.getElementById("projectSelect").value
            socket.emit("getLoaners",{project})
            socket.once("sendLoaners",(data)=>{
               
               let loans=data.loaners.loans 
               let buttons= document.getElementById("buttons")
               buttons.innerHTML=""
               // Loop through the loaner names and create a button element for each one
               for (const loaner in loans) {
               // Create a new button element
               const button = document.createElement("button");
               
               // Set the button's ID to the loaner name
               button.id = loaner;
               
               // Set the button's text content to the loaner name
               button.textContent = loaner;
                 // Add an event listener to the button that displays the form and requests the loan action
               button.addEventListener("click", () => {
                   document.getElementById("form").style.display = "flex";
                   socket.emit("getLoanAction", { loaner: loaner, project: document.getElementById("projectSelect").value });
                   document.getElementById("loaner3").innerHTML= loaner 
               });
               // Append the button to the parent element
               buttons.appendChild(button);
               }

           })
          

        })
        document.getElementById("add").addEventListener("click", () => {
            document.getElementById("buttons").style.display = "flex";
            document.getElementById("form").style.display = "none";
            document.getElementById("form2").style.display = "none";
            document.getElementById("form3").style.display = "none";
            let project = document.getElementById("projectSelect").value
            socket.emit("getLoaners",{project})
            socket.once("sendLoaners",(data)=>{
               
               let loans=data.loaners.loans 
               let buttons= document.getElementById("buttons")
               buttons.innerHTML=""
               // Loop through the loaner names and create a button element for each one
               for (const loaner in loans) {
               // Create a new button element
               const button = document.createElement("button");
               
               // Set the button's ID to the loaner name
               button.id = loaner;
               
               // Set the button's text content to the loaner name
               button.textContent = loaner;
                 // Add an event listener to the button that displays the form and requests the loan action
               button.addEventListener("click", () => {
                   document.getElementById("form2").style.display = "flex";
                   document.getElementById("form3").style.display = "none";
                   document.getElementById("loaner").innerHTML= loaner 
                   loanOwner=loaner
               });
               // Append the button to the parent element
               buttons.appendChild(button);
               }
               const button = document.createElement("button");
               // Set the button's ID to the loaner name
               button.id = "other";
               // Set the button's text content to the loaner name
               button.textContent = "other";
                   // Add an event listener to the button that displays the form and requests the loan action
                   button.addEventListener("click", () => {
                   document.getElementById("form3").style.display = "flex";
                   document.getElementById("form2").style.display = "none";
                   document.getElementById("loaner2").innerHTML= "other" 
               });
               // Append the button to the parent element
               buttons.appendChild(button);
           })
            

        })
        
        let check = false
        document.getElementById("resources").addEventListener("click", () => {

            event.preventDefault()
            if (!check) {
                check = true
                document.getElementById("resourceschedual").style.display = "block"
                document.getElementById("resources").innerHTML = "Hide Resources"
            }

            else {
                check = false
                document.getElementById("resourceschedual").style.display = "none"
                document.getElementById("resources").innerHTML = "Show Resources"
            }


        })

        //reseve schedual info
        socket.on("sendLoanAction", (projects) => {
            console.log("is sending")
            let project = projects;
            let statementDiv = document.getElementById("statment");
            statementDiv.innerHTML = ""; // clear the contents of the statement div

            // create a table element
            let tableElement = document.createElement("table");

            // create a table row for the table header
            let headerRow = document.createElement("tr");
            let keysToInclude2 = ["Loan", "Paid", "Remaining", "Date"];
            for (let i = 0; i < keysToInclude2.length; i++) {
                let headerCell = document.createElement("th");
                headerCell.textContent = keysToInclude2[i];
                headerRow.appendChild(headerCell);
            }
            tableElement.appendChild(headerRow);
            //specify the nassasry colomns
            let keysToInclude = ["StartingLoan", "paid", "remaining", "date"];
            // create a table row for each object in the project list
            console.log(project[project.length - 1].outSource)

            for (let i = 0; i < project.length; i++) {
                let dataRow = document.createElement("tr");
                for (let j = 0; j < keysToInclude.length; j++) {
                    let dataCell = document.createElement("td");
                    dataCell.textContent = project[i][keysToInclude[j]];
                    if(j==0)
                    dataCell.contentEditable = true; // make the cell editable

                    dataCell.addEventListener("click", function () {
                        // do something when the cell is clicked
                        console.log("Cell clicked!");
                        dataCell.addEventListener("blur", function () {
                            let rowIndex = dataRow.rowIndex - 1;
                            let row = {};
                            let rowCells = dataRow.getElementsByTagName("td");
                            for (let k = 0; k < rowCells.length; k++) {
                                let keysToInclude2 = ["Loan", "Paid", "Remaining", "Date"];
                                let cellValue = rowCells[k].textContent;
                                let cellKey = keysToInclude2[k];
                                row[cellKey] = cellValue;
                                
                            }
                            console.log(row)
                            row.projectOwner=document.getElementById("projectSelect").value
                            row.loanerChange=loaner
                            socket.emit("changeLoan",row)
                        });
                    });
                    dataRow.appendChild(dataCell);
                }
                tableElement.appendChild(dataRow);
            }

            statementDiv.appendChild(tableElement);


            //create the resource table 
            statementDiv = document.getElementById("resourceschedual");
            statementDiv.innerHTML = ""; // clear the contents of the statement div
            // create a table element
            tableElement = document.createElement("table");

            // create a table row for the table header
            headerRow = document.createElement("tr");
            keysToInclude2 = Object.keys(project[project.length-1].source)
             let index = keysToInclude2.indexOf("total");
            if (index !== -1) {
                keysToInclude2.splice(index, 1); // remove "description" from its current position
                keysToInclude2.push("total"); // add "description" to the end of the list
            }
            for (let i = 0; i < keysToInclude2.length; i++) {
                let headerCell = document.createElement("th");
                headerCell.textContent = keysToInclude2[i];
                headerRow.appendChild(headerCell);
            }
            tableElement.appendChild(headerRow);
            //specify the nassasry colomns
             keysToInclude = Object.keys(project[project.length-1].source);
             index = keysToInclude.indexOf("total");
            if (index !== -1) {
                keysToInclude.splice(index, 1); // remove "description" from its current position
                keysToInclude.push("total"); // add "description" to the end of the list
            }
            // create a table row for each object in the project list
            console.log(project[project.length - 1].outSource)

            for (let i = project.length - 1; i < project.length; i++) {
                let dataRow = document.createElement("tr");
                for (let j = 0; j < keysToInclude.length; j++) {
                    let dataCell = document.createElement("td");
                    
                    dataCell.textContent = project[i]["source"][keysToInclude[j]];
                 
                    
                     dataRow.appendChild(dataCell); 
                }
                tableElement.appendChild(dataRow);
            }

            statementDiv.appendChild(tableElement);

        })

    </script>
            
    <script>
            document.getElementById("existedLoan").addEventListener("click",()=>{
                event.preventDefault()
                console.log("clicked")
                let value = document.getElementById("loan").value
                if(value=== null || value==="")
                {
                    alert("please insert a value for the loan")
                    return
                }
                value=parseInt(value)
                console.log(typeof value)
                let loaner=loanOwner

                let date=document.getElementById("date").value
                if(date=== null || date==="")
                {
                    alert("please insert a date for the loan")
                    return
                }
                socket.emit("addLoan",{value,loaner,type:"existed",projectOwner,date})
            })


            document.getElementById("newLoan").addEventListener("click",()=>{
                event.preventDefault()
                console.log("clicked")
                let value = document.getElementById("loan2").value
                if(value=== null || value==="")
                {
                    alert("please insert a value for the loan")
                    return
                }
                value=parseInt(value)
                let loaner=document.getElementById("loanerName").value
                if(loaner=== null || loaner==="")
                {
                    alert("please insert a loaner name for the loan")
                    return
                }

                let words= loaner.split(" ")
                if(words.length>1){
                    alert(" loaner name cannot have space")
                    return
                }

                let date=document.getElementById("date2").value
                if(date=== null || date==="")
                {
                    alert("please insert a date for the loan")
                    return
                }
                socket.emit("addLoan",{value,loaner,type:"new",projectOwner,date})

            })


            socket.on("sendLoanersedit",(data)=>{
               
               let loans=data.loaners[0].loans 
               let buttons= document.getElementById("buttons")
               buttons.innerHTML=""
               // Loop through the loaner names and create a button element for each one
               for (const loaner in loans) {
               // Create a new button element
               const button = document.createElement("button");
               
               // Set the button's ID to the loaner name
               button.id = loaner;
               
               // Set the button's text content to the loaner name
               button.textContent = loaner;
                 // Add an event listener to the button that displays the form and requests the loan action
               button.addEventListener("click", () => {
                   document.getElementById("form2").style.display = "flex";
                   document.getElementById("form3").style.display = "none";
                   document.getElementById("loaner").innerHTML= loaner 
                   loanOwner=loaner
               });
               // Append the button to the parent element
               buttons.appendChild(button);
               }
               const button = document.createElement("button");
               // Set the button's ID to the loaner name
               button.id = "other";
               // Set the button's text content to the loaner name
               button.textContent = "other";
                   // Add an event listener to the button that displays the form and requests the loan action
                   button.addEventListener("click", () => {
                   document.getElementById("form3").style.display = "flex";
                   document.getElementById("form2").style.display = "none";
                   document.getElementById("loaner2").innerHTML= "other" 
               });
               // Append the button to the parent element
               buttons.appendChild(button);
           })
    </script>

    <script>
        socket.on("severResponse",(message)=>{
            alert(message)
        })
    </script>
</body>

</html>