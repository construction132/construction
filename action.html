<html>

<head>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="styles/style.css">
    <link rel="stylesheet" href="styles/statment.css">
</head>

<body>
    <section> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span>

        <div class="header">
            <a href="New.html" class="btn">project</a>
            <a href="action.html" class="btn">Cash in /Cash out</a>
            <a href="statment.html" class="btn">Statment</a>
            <a href="loan.html" class="btn">Loans</a>
            <a href="index.html" class="btn">Logout</a>
        </div>

        <div class="signin">
            <div id="content">
                <h1 style="color: rgb(0, 248, 0) ;">select a project</h1>
                <div id="choice"></div>
                <br>
                <button id="Submit">Submit</button>
            </div>
            <br>
            <div id="btns" style="display: none;">
                <button id="cashIn">Cash In</button>
                <button id="cashOut">Cash Out</button>
            </div>
            <h2 id="project" style="color: rgb(0, 248, 0);"></h2>
            <div id="cashin/out" style="display: none; flex-direction: column; width: 100%; align-items: center;">

                <div id="container2">

                    <div style="display: flex ; flex-direction:column; align-items: center; width: 400px;" id="cashin">
                        <h1 style="color: rgb(0, 248, 0);">Cash in</h1>
                        <div class="inputBox">

                            <input type="date" id="date2"> <i>Date</i>

                        </div>
                        <div class="inputBox">

                            <input type="number" name="" id="value"> <i>value</i>

                        </div>

                        <div class="inputBox">

                            <select name="source" id="giver" value="Abaa source">
                                <option value="" disabled selected>Select Giver</option>
                                <option value="abaa">Abaa</option>
                                <option value="umi">Umi</option>
                            </select>

                        </div>

                        <div class="inputBox">

                            <select name="source" id="Source" value="Abaa source">
                                <option value="" disabled selected>Select source</option>
                                <option value="abaa">Abaa</option>
                                <option value="umi">Umi</option>
                                <option value="UAE">UAE</option>
                               

                            </select>

                        </div>
                        <div class="inputBox">


                            <select name="source" id="To" value="Abaa source">


                            </select>

                        </div>
                        <div class="inputBox">
                            <input type="outSource" name="" id="purpose"> <i>purpose</i>
                        </div>


                        <input type="submit" name="" id="CashInSubmit">

                    </div>
                    <div style="display: none; flex-direction:column; align-items: center; width: 400px;" id="cashout">
                        <h1 style="color: rgb(0, 248, 0);">Cash out</h1>
                        <div class="inputBox">

                            <input type="date" id="date"> <i>Date</i>

                        </div>
                        <div class="inputBox">

                            <input type="number" name="" id="value2"> <i>value</i>

                        </div>
                        <div class="inputBox">

                            <select name="source" id="source2" value="Abaa source">
                                <option value="" disabled selected>Select source</option>
                                <option value="cash">cash</option>
                                <option value="rent">rent</option>
                            </select>

                        </div>
                        <div class="inputBox">

                            <select name="source" id="taker" value="Abaa source">
                                <option value="" disabled selected>Select Taker</option>
                            </select>

                        </div>

                        <div class="inputBox">

                            <select name="source" id="extrataker" style="display: none;">
                                <option value="" disabled selected>Select loan reciver</option>
                                <option value="abaa">abaa</option>
                                <option value="umi">umi</option>
                            </select>


                        </div>
                        <div class="inputBox">

                            <input type="text" name="" id="purpose2"> <i>purpose</i>

                        </div>

                        <input type="submit" name="" id="CashOutSubmit">
                    </div>

                </div>
            </div>
        </div>

    </section>

    <script>
        const socket = io()
        let username = "";
        const storedUsername = localStorage.getItem("username");
        if (storedUsername !== null) {
            username = storedUsername;

        }
        socket.emit("checkuser", username)

        socket.on("goLogin", (path) => {
            //locate the user to the path
            window.location = `./${path}`;
        })


        let projectOwner = ""
        socket.emit("getProjects");
        socket.on("sendProjects", (projects) => {
            project = projects;
            console.log('sending projects');
            let selectElement = document.createElement("select");
            selectElement.setAttribute("id", "projectSelect");

            for (let i = 0; i < projects.length; i++) {
                let optionElement = document.createElement("option");
                optionElement.textContent = projects[i].project;
                selectElement.appendChild(optionElement);
            }

            let choiceDiv = document.getElementById("choice");
            choiceDiv.innerHTML = "";
            choiceDiv.appendChild(selectElement);
        });


        document.getElementById("Submit").addEventListener("click", () => {
            document.getElementById("btns").style.display = "flex"
            document.getElementById("cashin/out").style.display = "flex"
            //get the name from the select project
            let selectElement = document.getElementById("projectSelect");
            let selectedProject = selectElement.value;
            document.getElementById("project").innerHTML = selectedProject + " Project"
            projectOwner = selectedProject
            socket.emit("getTakers", { projectOwner })
        })

        document.getElementById("cashIn").addEventListener("click", () => {
            console.log("hi")
            document.getElementById("cashin").style.display = "flex"
            document.getElementById("cashout").style.display = "none"
        })


        document.getElementById("cashOut").addEventListener("click", () => {
            document.getElementById("cashout").style.display = "flex"
            console.log("hi")
            document.getElementById("cashin").style.display = "none"
        })

        document.getElementById("CashOutSubmit").addEventListener("click", async () => {

            let date = document.getElementById("date").value
            if (date === null || date === "") {
                alert("dates must be specified")
                return
            }

            let value = 0
            let source = "-"
            let giver = "-"
            let to = "-"
            let to2 = "-"
            let purpose = "-"
            let actionType = "cash out"
            if (document.getElementById("value2").value !== null && document.getElementById("value2").value !== "")
                value = parseFloat(document.getElementById("value2").value)
            if (document.getElementById('source2').value !== null && document.getElementById("source2").value !== "")
                source = document.getElementById('source2').value
                
            if (document.getElementById('taker').value !== null && document.getElementById("taker").value !== "")
                to = document.getElementById('taker').value
            if (document.getElementById('purpose2').value !== null && document.getElementById("purpose2").value !== "")
                purpose = document.getElementById('purpose2').value


            console.log(`value: ${value},source: ${source}, giver: ${giver}, to: ${to}, purpose: ${purpose}, actionType: ${actionType}`);
            let projectOwner = document.getElementById("projectSelect").value


            names = to.split("/")
            first_name = names[0]


            if (first_name !== projectOwner  ) {
                console.log("in if")
                if(document.getElementById('extrataker').value !== null && document.getElementById("extrataker").value !== "")
                to2 = document.getElementById('extrataker').value
            }
            socket.emit("addAction", { actionType, value, source, giver, to, to2, purpose, projectOwner, date })

        })

        document.getElementById("CashInSubmit").addEventListener("click", () => {
            let date = document.getElementById("date2").value
            if (date === null || date === "") {
                alert("dates must be specified")
                return
            }
            let value = 0
            let source = "-"
            let giver = "-"
            let to = "-"
            let purpose = "-"
            let actionType = "cash in"
            if (document.getElementById("value").value !== null && document.getElementById("value").value !== "")
                value = parseFloat(document.getElementById("value").value)
            if (document.getElementById("giver").value !== null && document.getElementById("giver").value !== "")
                giver = document.getElementById("giver").value
            if (document.getElementById('Source').value !== null && document.getElementById("Source").value !== "")
            {
                source = document.getElementById('Source').value
               
            }
                
            if (document.getElementById('To').value !== null && document.getElementById("To").value !== "")
                to = document.getElementById('To').value
            if (document.getElementById('purpose').value !== null && document.getElementById("purpose").value !== "")
                purpose = document.getElementById('purpose').value
            console.log(`value: ${value}, source: ${source}, giver: ${giver}, to: ${to}, purpose: ${purpose}, actionType: ${actionType}`);

            let projectOwner = document.getElementById("projectSelect").value
            console.log(to)
            socket.emit("addAction", { actionType, value, source, giver, to, purpose, projectOwner, date })

        })

        socket.on("addedAction", (message) => {
            alert(message)
        })
    </script>

    <script>
        socket.on("sendTakers", (data) => {
            let takers = data.result
            console.log(takers)
            document.getElementById("taker").innerHTML = ""
            let option = document.createElement("option");
            option.value = "";
            option.disabled = true;
            option.selected = true;
            option.textContent = "Select Taker";

            document.getElementById("taker").appendChild(option);
            for (let i = 0; i < takers.length; i++) {
                let optionElement = document.createElement("option")

                optionElement.id = `${takers[i]}`
                optionElement.value = `${takers[i]}`
                optionElement.innerHTML = `${takers[i]}`
                optionElement.style.fontSize = "20px"
                document.getElementById("taker").appendChild(optionElement)
            }
            document.getElementById("taker").addEventListener("change", () => {
                let projectOwner = document.getElementById("projectSelect").value
                let [projectto, loanerto] = document.getElementById("taker").value.split('/');
                if (projectto!==projectOwner) {
                    console.log("not umi or abaa")
                    document.getElementById("extrataker").style.display = "";
                }
                else {
                    document.getElementById("extrataker").style.display = "none";
                }
                console.log("hi")
            })

        })
    </script>


    <script>
        //this is getting the loaners of the project
        document.getElementById("cashIn").addEventListener("click", () => {
            let projectOwner = document.getElementById("projectSelect").value
            socket.emit("getLoaners", { project: projectOwner })
        })
        //this is getting the loaners of the project
        document.getElementById("Submit").addEventListener("click", () => {
            let projectOwner = document.getElementById("projectSelect").value
            socket.emit("getLoaners", { project: projectOwner })
        })

        socket.on("sendLoaners", (data) => {
            console.log(data)
            let loaners = data.loaners
            let loans = loaners.loans
            console.log(loans)
            document.getElementById("To").innerHTML = ""
            let option = document.createElement("option");
            option.value = "";
            option.disabled = true;
            option.selected = true;
            option.textContent = "Select Taker";
            document.getElementById("To").appendChild(option);
            for (let loan in loans) {

                if (loan !== "abaa" && loan !== "umi") {
                    let optionElement = document.createElement("option")
                    optionElement.id = `${loan}`
                    optionElement.value = `${loan}`
                    optionElement.innerHTML = `${loan}`

                    document.getElementById("To").appendChild(optionElement)
                }

            }
        })

    </script>
    </section>
</body>

</html>